<!-- 
 * 3DCityDB-Web-Map
 * http://www.3dcitydb.org/
 * 
 * Copyright 2015 - 2016
 * Chair of Geoinformatics
 * Technical University of Munich, Germany
 * https://www.gis.bgu.tum.de/
 * 
 * The 3DCityDB-Web-Map is jointly developed with the following
 * cooperation partners:
 * 
 * virtualcitySYSTEMS GmbH, Berlin <http://www.virtualcitysystems.de/>
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 *     
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version (or Chrome Frame if pre-IE11). -->
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <link rel="icon" type="image/png" href="../../theme/img/favicon.png" sizes="16x16">
  <title>New York City demo</title>
  
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="../../ThirdParty/Cesium/Cesium.js"></script> 
  <script src="../../ThirdParty/Intersection/IntersectionAPI.js"></script>
  <script src="../../js/3dcitydb-web-map.js"></script>  
  <script src="../../js/CitydbUtil.js"></script>  
  <script src="../../js/CitydbWebworker.js"></script>
  <script src="../../js/CitydbSceneTransforms.js"></script> 
  <script src="../../js/CitydbKmlHighlightingManager.js"></script>   
  <script src="../../js/CitydbKmlTilingManager.js"></script>  
  <script src="../../js/CitydbKmlDataSource.js"></script>    
  <script src="../../js/CitydbKmlLayer.js"></script> 
  <script src= "../../js/d3.js"></script>
  <script src= "../../js/geotiff.js"></script>
  <script src= "../../js/jquery.js"></script>
  <script src= "../../js/proj4.js"></script>
    
  <style>
     @import url(../../ThirdParty/Cesium/Widgets/widgets.css);
      html, body, #cesiumContainer {
          top: 0px;
          left: 0px;
          position: absolute;
          width: 100%;
          height: 100%;
          margin: 0;
          padding: 0;
          overflow: hidden;
          z-index: -1;
      }
      #uiMenu {
          border-radius:5px;
          padding: 10px;
          position:absolute;
          left: 20px;
          font-family: "Arial";
          z-index: 99999;
      }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
   <div id="uiMenu">
    <button type="button" onclick="addgltfLayers()">add waterbody gltf Layer</button>
    <button type="button" onclick="addkmlLayers()">add waterbody kml Layer</button>
     <span>Time Controls: </span><button id="getPrevius" style="margin-top: 5px;">Backward</button> <button id="getNext" style="margin-top: 5px;">Forward</button></br>

  </div>
  <script>
	Cesium.BingMapsApi.defaultKey = 'ApOW9LMkerqWIVSnFauilSeaZyp8df66byy1USCTjgTdMvhb4y1iAhEsUHQfCgzq'
	       
    var s = 51.139942;
    var n = 51.143203;
    var w = 7.366514;
    var e = 7.373476;
  
	var viewer = new Cesium.Viewer('cesiumContainer', {
	   //   terrainExaggeration : 2.0

	});
	var extent = new Cesium.Rectangle.fromDegrees(w,s,e,n);
	viewer.camera.setView({destination: extent})
	
	var webMap = new WebMap3DCityDB(viewer);
	webMap.activateViewChangedEvent(true);
	var scene = viewer.scene;
	var buildingLayer;
	var lotLayer;
	var streetLayer;
 
 
 viewer.flyTo(
    viewer.dataSources.add(
        Cesium.KmlDataSource.load('../objects/roadal.kml', {
            camera: viewer.camera,
            canvas: viewer.canvas
        })
    ))
  viewer.dataSources.add(
        Cesium.KmlDataSource.load('../objects/betrieb.kml', {
            camera: viewer.camera,
            canvas: viewer.canvas
        })
    )
     viewer.dataSources.add(
        Cesium.KmlDataSource.load('../objects/doc.kml', {
            camera: viewer.camera,
            canvas: viewer.canvas
        })
    )
     viewer.dataSources.add(
        Cesium.KmlDataSource.load('../objects/pegel.kml', {
            camera: viewer.camera,
            canvas: viewer.canvas
        })
    )
      
      
       	var addgltfLayers = function() {
 
 
 
 gltf= new CitydbKmlLayer({
		 	url : '../objects/New Folder/pigel_collada_MasterJSON.json'  
           
		});
  
		 webMap.addLayer(gltf);
	 	    console.log(webMap)      

		gltf.registerEventHandler("FINISHLOADING", function(loadedcitydbLayer) {
			loadedcitydbLayer.zoomToStartPosition();
		});		
	};
  viewer.scene.globe.depthTestAgainstTerrain = false;
  viewer.scene.globe.showWaterEffect =true;
	var addkmlLayers = function() {
		kml = new CitydbKmlLayer({
		 
            url : '../objects/New Folder/pigel_extruded_MasterJSON.json'
		});
		 webMap.addLayer(kml); 
         kml.registerEventHandler("FINISHLOADING", function(loadedcitydbLayer) {
			loadedcitydbLayer.zoomToStartPosition();
		});	
	};	
    
    var terrainProvider = new Cesium.CesiumTerrainProvider({
     url: 'http://localhost/dashboard/cesium/Apps/terraincop'    

 //   url : '//assets.agi.com/stk-terrain/world'
    ,  requestVertexNormals : true  
 
    });
     viewer.terrainProvider = terrainProvider;


    
var cssColorArray=["#a7dbc7","#d6ea9a","#fff0b1","#ffd9ad","#ffb3d3","#ffffff"];
 
 var czml = [{"id":"document","name":"CZML Point","version":"1.0"},{"id":"DN_16","name":"DN_16","position":{"cartographicDegrees":[7.3701139,51.1419538,3.2]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/9/DN_16.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_5","name":"DN_5","position":{"cartographicDegrees":[7.367752,51.1429355,1]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/8/DN_5.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_11","name":"DN_11","position":{"cartographicDegrees":[7.3700398,51.1421139,2.2]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/15/DN_11.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_12","name":"DN_12","position":{"cartographicDegrees":[7.3699052,51.1420488,2.4]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/1/DN_12.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_6","name":"DN_6","position":{"cartographicDegrees":[7.3722347,51.1419865,1.2]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/17/DN_6.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_2","name":"DN_2","position":{"cartographicDegrees":[7.3687927,51.1425391,0.4]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/7/DN_2.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_7","name":"DN_7","position":{"cartographicDegrees":[7.3719655,51.1418563,1.4]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/10/DN_7.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_1","name":"DN_1","position":{"cartographicDegrees":[7.368898,51.1423509,0.2]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/13/DN_1.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_8","name":"DN_8","position":{"cartographicDegrees":[7.3702373,51.142338,1.6]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/16/DN_8.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_17","name":"DN_17","position":{"cartographicDegrees":[7.3700446,51.1419764,3.5]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/2/DN_17.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_3","name":"DN_3","position":{"cartographicDegrees":[7.3683733,51.1427861,0.6]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/18/DN_3.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_0","name":"DN_0","position":{"cartographicDegrees":[7.3690059,51.1423157,0.1]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/4/DN_0.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_10","name":"DN_10","position":{"cartographicDegrees":[7.3699703,51.1421446,2]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/5/DN_10.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_15","name":"DN_15","position":{"cartographicDegrees":[7.3701831,51.1419312,3]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/11/DN_15.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_9","name":"DN_9","position":{"cartographicDegrees":[7.3700365,51.1422087,1.8]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/3/DN_9.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_14","name":"DN_14","position":{"cartographicDegrees":[7.3699191,51.1420174,2.8]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/6/DN_14.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_13","name":"DN_13","position":{"cartographicDegrees":[7.3699191,51.1420174,2.6]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/12/DN_13.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}},{"id":"DN_4","name":"DN_4","position":{"cartographicDegrees":[7.3729122,51.1421856,0.8]},"model":{"gltf":"../objects/New Folder/New folder/Tiles/0/0/14/DN_4.gltf","colorBlendModes":"Replace","colorBlendAmount":1,"nodeTransformations":{"Y_UP_Transform":{"translation":{"cartesian":[0,0,0]}}}}}]

 
 // createCzml() ;
 
var start = Cesium.JulianDate.fromDate(new Date(2015, 2, 25, 16));
var stop = Cesium.JulianDate.addSeconds(start, 360, new Cesium.JulianDate());
var stop = Cesium.JulianDate.fromDate(new Date(2015, 2, 27, 16));
var middle = Cesium.JulianDate.addSeconds(start, 60, new Cesium.JulianDate());

//Make sure viewer is at the desired time.
viewer.clock.startTime = start.clone();
viewer.clock.stopTime = stop.clone();
viewer.clock.currentTime = start.clone();
viewer.clock.ClockStep = 1;
 
viewer.clock.multiplier = 10;
viewer.timeline.zoomTo(start, stop);
var start = viewer.clock.currentTime;
//var currentTime = Cesium.JulianDate.fromDate(new Date( ));
 var currentTime = start ;

 //var dataSource = Cesium.CzmlDataSource.load(czml);
 
// viewer.dataSources.add(dataSource);
//viewer.zoomTo(dataSource);
 
var cssColorArray=["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"];
var positionN=[];
var ellipsoid = Cesium.Ellipsoid.WGS84;
var idList=[];

Cesium.CzmlDataSource.updaters.push(czmlUpdater);
 
var czmldataSource = Cesium.CzmlDataSource.load(czml);
viewer.dataSources.add(czmldataSource).then(function(data){

var a =positionN.length

        
    var promis = Cesium.sampleTerrain(viewer.terrainProvider, 17, positionN);
        promis.then(function(terrainSamplePositions){ 
            var entities= data.entities;
          
            for (var i = 0; i < terrainSamplePositions.length; ++i) {
     
                var BaseHeight = terrainSamplePositions[i].height;//.toFixed(2);
                var entity = entities.getById(idList[i]);
                var cartesianOld = entity.position.getValue( currentTime);        
                var cartesianOldToCartography= ellipsoid.cartesianToCartographic(cartesianOld);
                var newHeight2 = BaseHeight +1* cartesianOldToCartography.height
                entity.position.setValue(Cesium.Cartesian3.fromRadians(cartesianOldToCartography.longitude,cartesianOldToCartography.latitude,newHeight2));
                
                            

              
            }
 
        });
 
}) ;
 
 //node transformation of the model 
 /// change position of the model 
 
 $('#getPrevius').on('click',function() {
	    console.log(viewer.clock.currentTime);
        viewer.clock.currentTime =  Cesium.JulianDate.addSeconds(viewer.clock.currentTime, 60, new Cesium.JulianDate());

     Cesium.loadWithXhr({
    url : '../objects/28feb.tif',
    responseType : 'arraybuffer'
}).then(function(response) {
   console.log(response);
  var rasterdata=  geotif(response);
   console.log(rasterdata);
     var dataSources = viewer.dataSources;
    var czmlEntities = dataSources.get(0).entities.values;
     
    czmlEntities .forEach(function(element) {

    element.model.nodeTransformations.Y_UP_Transform.translation = (new Cesium.Cartesian3(0,0,50) ) ;


    
    })
   
   
}).otherwise(function(error) { console.log(error);
    // an error occurred
});
   
	});
    
    
viewer.clock.onTick.addEventListener(function(clock) {
    var entity = viewer.selectedEntity;
 
 //console.log(clock.currentTime,middle)
    if (Cesium.defined(entity)    ) {
     
    var dataSources = viewer.dataSources;
    console.log(dataSources)
    console.log(entity)
    var czmlEntities = dataSources.get(0).entities.values;
   // console.log(czmlEntities)
    var hh = 100; 
    czmlEntities .forEach(function(element) {
    //    var cartesianOldToCartography= ellipsoid.cartesianToCartographic(element.position.getValue(clock));
 
      //  element.position.setValue( Cesium.Cartesian3.fromRadians(cartesianOldToCartography.longitude,cartesianOldToCartography.latitude, hh));
      //  hh+=10
      
      
 })
 
}
   if ( Cesium.JulianDate.equals(clock.currentTime,start )){
  //  console.log(clock)
     Cesium.loadWithXhr({
    url : '../objects/28feb.tif',
    responseType : 'arraybuffer'
}).then(function(response) {
   console.log(response);
  var rasterdata=  geotif(response);
   console.log(rasterdata);
}).otherwise(function(error) { console.log(error);
    // an error occurred
});
   
   
   }
  
//var entity = viewer.selectedEntity;
//  if (!Cesium.defined(entity) ) {  
 
    
});


//add color to any czml loaded 
  function czmlUpdater(dynamicObject, packet, dynamicObjectCollection, sourceUri) {
  
        var height = packet.position.cartographicDegrees[2]
        var color =  setColor(height,cssColorArray,[0,0.3]);
        color= {"rgba": [255*color.red,255*color.green ,255*color.blue,255* color.alpha]}
        packet.model.color =  color;
        currentPosition = packet.position.cartographicDegrees;
        positionN.push(  new Cesium.Cartographic(Cesium.Math.toRadians(  currentPosition[0]), Cesium.Math.toRadians( currentPosition[1]) ));
        idList.push(packet.id)
      
    }



  function createCzml(){     
     var czml = [{
        "id" : "document",
        "name" : "CZML Point",
        "version" : "1.0"  }];
     var kmlPath = "../objects/New Folder/New folder/Tiles/0/0/pigel_Tile_0_0_collada.kml";
     var kmlFolder= kmlPath.replace(/\/[^\/]+$/, '');
        
    $.get(kmlPath, function(data){

        $(data).find("Placemark").each(function(index, value){
            var that =$(this);
            var id = that.attr( "id" );
            var name = that.find( "name" ).text();
            var locationNode= that.find( "Location" );
            var location = [parseFloat(locationNode.find( "longitude" ).text()),parseFloat(locationNode.find( "latitude" ).text()),parseFloat(locationNode.find( "altitude" ).text())];
            var path =  that.find( "href" ).text();
            if (id){
            
                var packet =  {
                            "id":  name,
                            "name": name,
                            "position": {
                                "cartographicDegrees": location
                            },
                            "model": {
                                "gltf": kmlFolder +"/"+path ,
                                "colorBlendModes": "Replace",
                                "colorBlendAmount": 1 ,
                                "nodeTransformations": { 
                                    "Y_UP_Transform": {
                                            "translation": {
                                                    "cartesian":[0,0,0]}
                                    }
                                }
                                
                            }               
                } 
                czml.push(packet);
            
            }
        });
 console.log(JSON.stringify(czml));

   return czml;
});
}
 

function setColor(height,cssColorArray,heightIntervals){
    var startHeight= heightIntervals[0];
    var interval = heightIntervals[1];
 //   var endHeight= heightIntervals[2];
    var rangeIndex;
    if  ( height<=startHeight){
                rangeIndex =10;
            }else if (height >startHeight && height<=(startHeight+1*interval) ){
                rangeIndex =10;
            }else if (height >(startHeight+1*interval) && height<=(startHeight+2*interval) ){
                rangeIndex =9;
            }else if (height >(startHeight+2*interval)  && height<=(startHeight+3*interval) ){
                rangeIndex =8;
            }else if (height >(startHeight+3*interval)  && height<=(startHeight+4*interval)  ){
                rangeIndex =7;
            }else if (height >(startHeight+4*interval)  && height<=(startHeight+5*interval)  ){
                rangeIndex =6;
            }else if (height >(startHeight+5*interval)  && height<=(startHeight+6*interval)  ){
                rangeIndex =5;
            }else if (height >(startHeight+6*interval)  && height<=(startHeight+7*interval)  ){
                rangeIndex =4;
            }else if (height >(startHeight+7*interval)  && height<=(startHeight+8*interval)  ){
                rangeIndex =3;
            }else if (height >(startHeight+8*interval)  && height<=(startHeight+9*interval)  ){
                rangeIndex =2;
            }else if (height >(startHeight+9*interval)  && height<=(startHeight+10*interval)  ){
                rangeIndex =1;
            }else if (height >(startHeight+9*interval)  ){
                rangeIndex =0;
            }
    var color= new Cesium.Color.fromCssColorString(cssColorArray[rangeIndex]);
    
    return color;
}

 
  
  function geotif(RR){
 
 
    var tiff = GeoTIFF.parse(RR);
    var image = tiff.getImage();
 
    var rasters= image.readRasters();
    var tiepoint = image.getTiePoints()[0];
    var pixelScale = image.getFileDirectory().ModelPixelScale;
    var geoTransform = [tiepoint.x, pixelScale[0], 0, tiepoint.y, 0, -1*pixelScale[1]];
    var height = image.getHeight() //geoTransform[1];
    var width = Math.abs( image.getWidth())///geoTransform[5]);
    var invGeoTransform = [-geoTransform[
    0]/geoTransform[1], 1/geoTransform[1],0,-geoTransform[3]/geoTransform[5],0,1/geoTransform[5]];
 return [rasters,geoTransform,[height,width]]
 
 }
  minValue= 2457127
  maxValue= 2557127
 
 function fitRange(num){
             Number.prototype.map = function (in_min, in_max, out_min, out_max) {
                      return (this - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
                                     };
                   return num.map(minValue,maxValue,0,1);//maxValue-minValue);
        
             }
 
</script>
</body>
</html>
